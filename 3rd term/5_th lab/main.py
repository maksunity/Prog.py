import folium
import pandas as pd


def load_metro_data(filename):
    """Загружает данные о станциях метро из TSV файла"""
    data = pd.read_csv(filename, sep='\t')
    return data


def get_district_mapping():
    """Возвращает словарь сопоставления станций и административных округов Москвы"""
    districts = {
        'ЦАО': ['Александровский сад', 'Арбатская', 'Баррикадная', 'Белорусская', 
                'Библиотека им. Ленина', 'Боровицкая', 'Чеховская', 'Чистые пруды',
                'Чкаловская', 'Добрынинская', 'Фрунзенская', 'Киевская', 'Китай город',
                'Кропоткинская', 'Курская', 'Ленинский проспект', 'Лубянка', 'Маяковская',
                'Менделеевская', 'Новокузнецкая', 'Новослободская', 'Октябрьская', 'Охотный ряд',
                'Павелецкая', 'Парк культуры', 'Полянка', 'Пушкинская', 'Серпуховская',
                'Смоленская', 'Сретенский бульвар', 'Сухаревская', 'Таганская', 'Театральная',
                'Тверская', 'Третьяковская', 'Трубная', 'Тургеневская', 'Цветной бульвар',
                'Электрозаводская', 'Красные Ворота', 'Комсомольская', 'Проспект Мира',
                'Краснопресненская', 'Красносельская', 'Новые Черемушки'],
        
        'САО': ['Аэропорт', 'Алексеевская', 'Бабушкинская', 'Беговая', 'Бибирево',
                'Ботанический сад', 'Динамо', 'Дмитровская', 'Алтуфьево', 'Владыкино',
                'Отрадное', 'Петровско-Разумовская', 'Речной вокзал', 'Савеловская',
                'Свиблово', 'Тимирязевская', 'Водный стадион', 'Войковская', 'Волоколамская',
                'Сокол', 'ВДНХ'],
        
        'СВАО': ['Бабушкинская', 'Бибирево', 'Ботанический сад', 'Медведково', 'Рижская',
                 'Свиблово', 'ВДНХ', 'Алексеевская', 'Черкизовская'],
        
        'ВАО': ['Авиамоторная', 'Шоссе энтузиастов', 'Измайловская', 'Первомайская',
                'Партизанская', 'Перово', 'Семеновская', 'Шоссе энтузиастов', 'Щелковская',
                'Новогиреево', 'Новокосино', 'Электрозаводская', 'Черкизовская', 'Преображенская площадь',
                'Бульвар Рокоссовского', 'Локомотив', 'Измайлово', 'Соколиная Гора', 'Сокольники'],
        
        'ЮВАО': ['Автозаводская', 'Братеево', 'Братиславская', 'Дубровка', 'Каширская',
                 'Коломенская', 'Кузьминки', 'Люблино', 'Марьино', 'Печатники',
                 'Текстильщики', 'Волжская', 'Выхино', 'Жулебино', 'Кожуховская',
                 'Лермонтовский проспект', 'Рязанский проспект', 'Таганская', 'Нижегородская',
                 'Стахановская', 'Угрешская', 'Дубровка', 'Крестьянская Застава'],
        
        'ЮАО': ['Аннино', 'Битцевский парк', 'Чертаново', 'Бульвар Дмитрия Донского',
                'Каховская', 'Калужская', 'Коньково', 'Нахимовский проспект', 'Нагатинская',
                'Нагорная', 'Орехово', 'Пражская', 'Профсоюзная', 'Севастопольская',
                'Улица Академика Янгеля', 'Царицыно', 'Беляево', 'Варшавская', 'Домодедовская',
                'Кантемировская', 'Академическая', 'Улица Старокачаловская', 'Лесопарковая',
                'Зябликово', 'Красногвардейская', 'Алма-Атинская', 'Шипиловская', 'Каширская'],
        
        'ЮЗАО': ['Академическая', 'Беляево', 'Калужская', 'Коньково', 'Ленинский проспект',
                 'Новые Черемушки', 'Октябрьская', 'Профсоюзная', 'Теплый Стан',
                 'Тропарево', 'Университет', 'Юго-Западная', 'Ясенево', 'Проспект Вернадского',
                 'Раменки', 'Ломоносовский проспект', 'Минская', 'Озерная'],
        
        'ЗАО': ['Багратионовская', 'Филевский парк', 'Фили', 'Кунцевская', 'Крылатское',
                'Кутузовская', 'Молодежная', 'Парк Победы', 'Пионерская', 'Славянский бульвар',
                'Студенческая', 'Киевская', 'Смоленская', 'Выставочная', 'Международная',
                'Строгино', 'Митино', 'Мякинино', 'Солнцево', 'Говорово', 'Боровское шоссе',
                'Новопеределкино', 'Рассказовка'],
        
        'СЗАО': ['Динамо', 'Полежаевская', 'Сходненская', 'Тушинская', 'Щукинская',
                 'Октябрьское поле', 'Планерная', 'Пятницкое шоссе', 'Митино', 'Волоколамская',
                 'Мякинино', 'Строгино', 'Спартак', 'Хорошево', 'Народное Ополчение',
                 'Войковская', 'Водный стадион', 'Речной вокзал'],
        
        'ЗелАО': ['Зеленоград'],
        
        'ТАО': ['Бунинская аллея', 'Улица Горчакова', 'Бульвар Адмирала Ушакова',
                'Улица Скобелевская'],
    }
    
    station_to_district = {}
    for district, stations in districts.items():
        for station in stations:
            station_to_district[station] = district
    
    return station_to_district


def get_district_colors():
    """Возвращает цвета для каждого административного округа"""
    colors = {
        'ЦАО': 'red',
        'САО': 'blue',
        'СВАО': 'green',
        'ВАО': 'purple',
        'ЮВАО': 'orange',
        'ЮАО': 'darkred',
        'ЮЗАО': 'lightred',
        'ЗАО': 'darkblue',
        'СЗАО': 'darkgreen',
        'ЗелАО': 'lightgreen',
        'ТАО': 'pink',
        'Не определен': 'gray'
    }
    return colors


def assign_districts(data):
    """Присваивает каждой станции административный округ"""
    district_mapping = get_district_mapping()
    data['Округ'] = data['Название'].apply(
        lambda x: district_mapping.get(x, 'Не определен')
    )
    return data


def create_metro_map(data):
    """Создает интерактивную карту с маркерами станций метро"""
    moscow_coords = [55.7558, 37.6173]
    metro_map = folium.Map(
        location=moscow_coords,
        zoom_start=11,
        tiles='OpenStreetMap'
    )
    
    colors = get_district_colors()
    
    for idx, row in data.iterrows():
        station_name = row['Название']
        lat = row['Широта']
        lon = row['Долгота']
        district = row['Округ']
        color = colors.get(district, 'gray')
        
        popup_text = f"""
        <b>Станция:</b> {station_name}<br>
        <b>Координаты:</b> {lat}, {lon}<br>
        <b>Округ:</b> {district}
        """
        
        folium.CircleMarker(
            location=[lat, lon],
            radius=6,
            popup=folium.Popup(popup_text, max_width=300),
            color=color,
            fill=True,
            fillColor=color,
            fillOpacity=0.7,
            weight=2
        ).add_to(metro_map)
    
    add_legend(metro_map)
    
    return metro_map


def add_legend(metro_map):
    """Добавляет легенду с округами на карту"""
    colors = get_district_colors()
    
    legend_html = '''
    <div style="position: fixed; 
                bottom: 50px; right: 50px; width: 200px; height: auto; 
                background-color: white; z-index:9999; font-size:14px;
                border:2px solid grey; border-radius: 5px; padding: 10px">
    <p style="margin-top:0; font-weight: bold;">Административные округа:</p>
    '''
    
    for district, color in colors.items():
        if district != 'Не определен':
            legend_html += f'<p style="margin:5px 0;"><span style="background-color:{color}; \
                          width:15px; height:15px; display:inline-block; margin-right:5px; \
                          border: 1px solid black;"></span>{district}</p>'
    
    legend_html += '</div>'
    
    metro_map.get_root().html.add_child(folium.Element(legend_html))


def save_map(metro_map, filename='metro_map.html'):
    """Сохраняет карту в HTML файл"""
    metro_map.save(filename)
    print(f'Карта сохранена в файл: {filename}')


def main():
    """Основная функция программы"""
    print('Загрузка данных о станциях метро...')
    data = load_metro_data('metro.tsv')
    
    print('Присвоение административных округов...')
    data = assign_districts(data)
    
    print('Создание интерактивной карты...')
    metro_map = create_metro_map(data)
    
    print('Сохранение карты...')
    save_map(metro_map)
    
    print('\nГотово! Откройте файл metro_map.html в браузере.')
    print(f'Всего станций: {len(data)}')
    print('\nРаспределение станций по округам:')
    print(data['Округ'].value_counts())


if __name__ == '__main__':
    main()
